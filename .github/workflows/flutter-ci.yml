name: Flutter CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build-android:
    name: 构建 Android APK
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Java 环境
      - name: 设置 Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      # 3. 设置 Flutter 环境
      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'  # 使用稳定版本
          channel: 'stable'
          cache: true

      # 4. 检查 Flutter 版本
      - name: 检查 Flutter 版本
        run: flutter --version

      # 5. 获取依赖
      - name: 获取 Flutter 依赖
        run: flutter pub get

      # 6. 代码分析 (可选)
      - name: 运行 Flutter 代码分析
        run: flutter analyze
        continue-on-error: true  # 即使分析失败也继续构建

      # 7. 运行测试 (可选)
      - name: 运行 Flutter 测试
        run: flutter test
        continue-on-error: true

      # 8. 构建 Debug APK
      - name: 构建 Debug APK
        run: flutter build apk --debug

      # 9. 构建 Release APK
      - name: 构建 Release APK
        run: flutter build apk --release

      # 10. 构建 App Bundle (可选)
      - name: 构建 App Bundle
        run: flutter build appbundle --release
        continue-on-error: true

      # 11. 上传 Debug APK
      - name: 上传 Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 7

      # 12. 上传 Release APK
      - name: 上传 Release APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30

      # 13. 上传 App Bundle (如果构建成功)
      - name: 上传 App Bundle
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: release-aab
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
        continue-on-error: true

      # 14. 创建构建信息文件
      - name: 生成构建信息
        run: |
          echo "构建时间: $(date)" > build-info.txt
          echo "分支: ${{ github.ref_name }}" >> build-info.txt
          echo "提交: ${{ github.sha }}" >> build-info.txt
          echo "构建号: ${{ github.run_number }}" >> build-info.txt

      - name: 上传构建信息
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: build-info.txt
          retention-days: 30

  # 可选: iOS 构建任务
  build-ios:
    name: 构建 iOS (需要 macOS)
    runs-on: macos-latest
    if: false  # 默认禁用,如需启用改为 true

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 构建 iOS (无签名)
        run: flutter build ios --release --no-codesign

      - name: 上传 iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/Runner.app
          retention-days: 7